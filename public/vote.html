<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Quiplash — Vote</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <div id="app">
    <h1>Vote / Results</h1>
    <div id="votingArea" style="display:none;">
      <h3>Rank answers (1 = best)</h3>
      <form id="rankingForm"></form>
      <button id="submitRanking">Submit Ranking</button>
      <p id="votingMsg"></p>
    </div>

    <div id="resultsArea" style="display:none;">
      <h3>Results</h3>
      <div id="resultsDiv"></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    socket.emit('identify', { role: 'player' });
    let currentSubmissions = [];

    socket.on('phase', ({ phase, submissions, results }) => {
      document.getElementById('votingMsg').textContent = '';
      if (phase === 'voting') {
        currentSubmissions = submissions || [];
        renderRankingForm();
        document.getElementById('votingArea').style.display = 'block';
        document.getElementById('resultsArea').style.display = 'none';
      } else if (phase === 'results') {
        document.getElementById('votingArea').style.display = 'none';
        document.getElementById('resultsArea').style.display = 'block';
        renderResults(results);
      } else {
        // lobby or submission -> show message and hide sections
        document.getElementById('votingArea').style.display = 'none';
        document.getElementById('resultsArea').style.display = 'none';
      }
    });

    function renderRankingForm() {
      const f = document.getElementById('rankingForm');
      f.innerHTML = '';
      if (!currentSubmissions || currentSubmissions.length === 0) {
        f.textContent = 'No submissions to rank.';
        return;
      }
      const N = currentSubmissions.length;
      currentSubmissions.forEach((s, idx) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'rankItem';
        const label = document.createElement('label');
        label.textContent = s.text;
        const sel = document.createElement('select');
        sel.dataset.sid = s.id;
        for (let i = 1; i <= N; i++) {
          const opt = document.createElement('option');
          opt.value = i;
          opt.text = i;
          sel.appendChild(opt);
        }
        sel.value = ((idx % N) + 1);
        wrapper.appendChild(label);
        wrapper.appendChild(sel);
        f.appendChild(wrapper);
      });
    }

    document.getElementById('submitRanking').onclick = () => {
      const selects = Array.from(document.querySelectorAll('#rankingForm select'));
      const ranks = {};
      const used = new Set();
      for (const s of selects) {
        const sid = s.dataset.sid;
        const rank = parseInt(s.value, 10);
        if (used.has(rank)) {
          document.getElementById('votingMsg').textContent = 'Each rank must be unique.';
          return;
        }
        used.add(rank);
        ranks[sid] = rank;
      }
      socket.emit('submitRanking', { ranks });
      document.getElementById('votingMsg').textContent = 'Ranking submitted!';
    };

    function renderResults(results) {
      const d = document.getElementById('resultsDiv');
      d.innerHTML = '';
      if (!results) return;
      results.forEach(r => {
        const item = document.createElement('div');
        item.className = 'card result';
        item.innerHTML = `<strong>${r.score}</strong> — ${r.text}`;
        d.appendChild(item);
      });
    }
  </script>
</body>
</html>

